# Databricks Notebook DevOps Pipeline
## Expects two variables defined: databricksWorkspaceURL, databricksAccessToken

# specific path build
trigger:
  branches:
    include:
    - main
    - releases/*
  paths:
    include:
    - databricks/*
    - ml/*

pool:
  # This VM Image is recommended for Databricks deployment extension
  vmImage: 'ubuntu-16.04'

stages:
- stage: BuildMLSourceAssets
  jobs:
  - job: BuildDatabricks
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
          addToPath: true
          architecture: 'x64'
      - task: Bash@3
        displayName: 'Install Testing Requirements'
        inputs:
          targetType: 'inline'
          script: 'pip install databricks-test spark-testing-base pyspark'
      
      - script: |
          pip install pytest
          pip install pytest-cov
          pytest ./databricks/tests --doctest-modules --junitxml=junit/test-results.xml --cov=. --cov-report=xml --cov-report=html
        displayName: 'Test with pytest'
      

- stage: DeployToTest
  jobs:
  - job: DeployDatabricksNotebooks
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.7'
          addToPath: true
          architecture: 'x64'
      - task: configuredatabricks@0
        inputs:
          url: '$(databricksWorkspaceURL)'
          token: '$(databricksAccessToken)'
      - task: deploynotebooks@0
        inputs:
          notebooksFolderPath: '$(System.DefaultWorkingDirectory)/databricks/notebooks'
          workspaceFolder: '/Shared/DemoApp'
      
      
